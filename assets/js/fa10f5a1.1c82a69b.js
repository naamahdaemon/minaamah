"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[7071],{30953:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>o,contentTitle:()=>t,default:()=>h,frontMatter:()=>s,metadata:()=>c,toc:()=>l});var i=a(85893),r=a(11151);const s={sidebar_position:2,sidebar_label:"Running Mina Archive Node with Docker",sidebar_class_name:"green"},t="Running Mina Mainnet Archive Node on Docker",c={id:"Node operator guide/Run_Docker_Mainnet/running_docker_mainnet_archive",title:"Running Mina Mainnet Archive Node on Docker",description:"Installing Postgres Database Docker Container",source:"@site/docs/04-Node operator guide/Run_Docker_Mainnet/running_docker_mainnet_archive.md",sourceDirName:"04-Node operator guide/Run_Docker_Mainnet",slug:"/Node operator guide/Run_Docker_Mainnet/running_docker_mainnet_archive",permalink:"/docs/Node operator guide/Run_Docker_Mainnet/running_docker_mainnet_archive",draft:!1,unlisted:!1,editUrl:"https://github.com/naamahdaemon/minaamah/tree/main/docs/04-Node operator guide/Run_Docker_Mainnet/running_docker_mainnet_archive.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,sidebar_label:"Running Mina Archive Node with Docker",sidebar_class_name:"green"},sidebar:"mainSidebar",previous:{title:"Running Mainnet using Docker",permalink:"/docs/Node operator guide/Run_Docker_Mainnet/running_docker_mainnet"},next:{title:"Running Mina Berkeley Node with Docker",permalink:"/docs/Node operator guide/Running_Docker_Berkeley_Node/running_berkeley"}},o={},l=[{value:"Installing Postgres Database Docker Container",id:"installing-postgres-database-docker-container",level:2},{value:"Pull image",id:"pull-image",level:3},{value:"Run container",id:"run-container",level:3},{value:"create Database",id:"create-database",level:3},{value:"Import database",id:"import-database",level:3},{value:"Installing Mina Archive Node",id:"installing-mina-archive-node",level:2},{value:"Get docker image",id:"get-docker-image",level:3},{value:"Create temporary directory",id:"create-temporary-directory",level:3},{value:"Create local directory to store stuff and wget the latest database dump",id:"create-local-directory-to-store-stuff-and-wget-the-latest-database-dump",level:3},{value:"Import the dump into postgres",id:"import-the-dump-into-postgres",level:3},{value:"Starting the mina-archive container",id:"starting-the-mina-archive-container",level:3},{value:"Running mina-archive",id:"running-mina-archive",level:3},{value:"Catchup missing blocks",id:"catchup-missing-blocks",level:2},{value:"USEFUL COMMANDS",id:"useful-commands",level:2},{value:"List running docker containers",id:"list-running-docker-containers",level:3},{value:"Docker container logs",id:"docker-container-logs",level:3},{value:"Launch interactive shell session",id:"launch-interactive-shell-session",level:3},{value:"POSTGRES Container",id:"postgres-container",level:5},{value:"Mina Container",id:"mina-container",level:5},{value:"Mina Archive Container",id:"mina-archive-container",level:5},{value:"Copy a local file to a container",id:"copy-a-local-file-to-a-container",level:5},{value:"Running Mina Archive Container",id:"running-mina-archive-container",level:5},{value:"Running the <code>postgres</code> container",id:"running-the-postgres-container",level:5}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h5:"h5",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"running-mina-mainnet-archive-node-on-docker",children:"Running Mina Mainnet Archive Node on Docker"}),"\n",(0,i.jsx)(n.h2,{id:"installing-postgres-database-docker-container",children:"Installing Postgres Database Docker Container"}),"\n",(0,i.jsx)(n.h3,{id:"pull-image",children:"Pull image"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker pull postgres\n"})}),"\n",(0,i.jsx)(n.h3,{id:"run-container",children:"Run container"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker run --name postgres -p 5432:5432 -e POSTGRES_PASSWORD=postgres -d postgres\n"})}),"\n",(0,i.jsx)(n.h3,{id:"create-database",children:"create Database"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker exec -it postgres createdb -U postgres archive\n"})}),"\n",(0,i.jsx)(n.admonition,{title:"Liste databases",type:"info",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'echo "SELECT datname FROM pg_database;" | docker exec -i postgres psql -U postgres -d archive\n'})})}),"\n",(0,i.jsx)(n.h3,{id:"import-database",children:"Import database"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl -Ls https://raw.githubusercontent.com/MinaProtocol/mina/master/src/app/archive/create_schema.sql | docker exec -i postgres psql -U postgres -d archive\n"})}),"\n",(0,i.jsx)(n.admonition,{title:"List all databases",type:"info",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'echo "\\dt" | docker exec -i postgres psql -U postgres -d archive\n'})})}),"\n",(0,i.jsx)(n.h2,{id:"installing-mina-archive-node",children:"Installing Mina Archive Node"}),"\n",(0,i.jsx)(n.h3,{id:"get-docker-image",children:"Get docker image"}),"\n",(0,i.jsxs)(n.p,{children:["As for the mina-daemon github image, you can look for the latest version of ",(0,i.jsx)(n.code,{children:"mina-archive"})," matching your ",(0,i.jsx)(n.code,{children:"mina-daemon"})," version from docker hub :"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'curl -sN "https://registry.hub.docker.com/v2/repositories/minaprotocol/mina-archive/tags?ordering=last_updated&name=1.4.1" | jq -r \'.results[] | select(.name | contains("focal")) | " \\(.last_updated) \\t \\(.name)"\'\n'})}),"\n",(0,i.jsxs)(n.p,{children:["This command will look for the latest ",(0,i.jsx)(n.code,{children:"1.4.1"})," ",(0,i.jsx)(n.code,{children:"focal"})," release of mina-archive. it will return the following :"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:" 2024-03-28T06:00:26.05546Z      1.4.1-e76fc1c-focal\n 2024-03-14T21:13:27.723574Z     1.4.1-master-ad8ed6e-focal\n 2024-03-14T16:51:27.896839Z     1.4.1-21acbdc-focal\n 2024-03-12T21:57:15.389135Z     1.4.1beta1-21acbdc-focal\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Then you will just have to pick the latest version available which is in this case ",(0,i.jsx)(n.code,{children:"1.4.1-e76fc1c-focal"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker pull minaprotocol/mina-archive:1.4.1-e76fc1c-focal\n"})}),"\n",(0,i.jsx)(n.h3,{id:"create-temporary-directory",children:"Create temporary directory"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"mkdir -p /tmp/archive\n"})}),"\n",(0,i.jsx)(n.h3,{id:"create-local-directory-to-store-stuff-and-wget-the-latest-database-dump",children:"Create local directory to store stuff and wget the latest database dump"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"mkdir archive_node\ncd archive_node/\nwget --inet4-only https://storage.googleapis.com/mina-archive-dumps/mainnet-archive-dump-2024-03-28_0001.sql.tar.gz\ntar xvf mainnet-archive-dump-2024-03-28_0001.sql.tar.gz\n"})}),"\n",(0,i.jsxs)(n.admonition,{title:"How to get the latest database dump available ?",type:"info",children:[(0,i.jsx)(n.p,{children:"From a google cloud console, you can look for the latest database dump available using the following command line :"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"gsutil ls -l gs://mina-archive-dumps/mainnet* | grep mainnet-archive-dump | grep 2024-03\n"})}),(0,i.jsxs)(n.p,{children:["This will search for all ",(0,i.jsx)(n.code,{children:"mainnet"})," archive dumps available for March, 2024."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"1037223471  2024-03-01T00:09:00Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-01_0001.sql.tar.gz\n1038036714  2024-03-02T00:09:27Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-02_0001.sql.tar.gz\n1038705304  2024-03-03T00:09:12Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-03_0001.sql.tar.gz\n1040347494  2024-03-04T00:09:28Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-04_0001.sql.tar.gz\n1041544668  2024-03-05T00:09:07Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-05_0001.sql.tar.gz\n1042530101  2024-03-06T00:09:16Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-06_0001.sql.tar.gz\n1043968663  2024-03-07T00:09:20Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-07_0001.sql.tar.gz\n1046183259  2024-03-08T00:09:21Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-08_0001.sql.tar.gz\n1048471704  2024-03-09T00:12:17Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-09_0003.sql.tar.gz\n1050222256  2024-03-10T00:09:04Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-10_0001.sql.tar.gz\n1052718697  2024-03-11T00:09:06Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-11_0001.sql.tar.gz\n1054899270  2024-03-12T00:09:22Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-12_0001.sql.tar.gz\n1056512846  2024-03-13T00:09:14Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-13_0001.sql.tar.gz\n1058309593  2024-03-14T00:09:12Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-14_0001.sql.tar.gz\n1059496578  2024-03-15T00:09:40Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-15_0001.sql.tar.gz\n1060379733  2024-03-16T00:09:25Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-16_0001.sql.tar.gz\n1061349319  2024-03-17T00:09:39Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-17_0001.sql.tar.gz\n1063031545  2024-03-18T00:09:30Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-18_0001.sql.tar.gz\n1064066717  2024-03-19T00:10:01Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-19_0001.sql.tar.gz\n1064937270  2024-03-20T00:09:13Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-20_0001.sql.tar.gz\n1066622955  2024-03-21T00:08:56Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-21_0001.sql.tar.gz\n1067571505  2024-03-22T00:08:54Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-22_0001.sql.tar.gz\n1069661202  2024-03-23T00:09:05Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-23_0001.sql.tar.gz\n1071691612  2024-03-24T00:09:06Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-24_0001.sql.tar.gz\n1073968497  2024-03-25T00:08:56Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-25_0001.sql.tar.gz\n1075411684  2024-03-26T00:09:19Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-26_0001.sql.tar.gz\n1076374149  2024-03-27T00:09:14Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-27_0001.sql.tar.gz\n1078286270  2024-03-28T00:09:15Z  gs://mina-archive-dumps/mainnet-archive-dump-2024-03-28_0001.sql.tar.gz\n"})}),(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["The latest dump available is ",(0,i.jsx)(n.code,{children:"mainnet-archive-dump-2024-03-28_0001.sql.tar.gz"})]})})]}),"\n",(0,i.jsx)(n.h3,{id:"import-the-dump-into-postgres",children:"Import the dump into postgres"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker cp mainnet-archive-dump-2024-03-28_0001.sql postgres:/mainnet-archive-dump-2024-03-28_0001.sql\ndocker exec -i postgres psql -U postgres -d archive -f /mainnet-archive-dump-2024-03-28_0001.sql\n"})}),"\n",(0,i.jsxs)(n.admonition,{title:"checking everything is ok after the dump is imported",type:"info",children:[(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker exec -it postgres  bash\n"})}),(0,i.jsx)(n.p,{children:"Then once in the container :"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"root@f4f526a38062:/## psql -U postgres -d archive_balances_migrated\narchive_balances_migrated=## SELECT datname FROM pg_catalog.pg_database;\n          datname\n---------------------------\n postgres\n archive\n template1\n template0\n archive_balances_migrated\n(5 rows)\narchive_balances_migrated=## \\dt\n                  List of relations\n Schema |           Name           | Type  |  Owner\n--------+--------------------------+-------+----------\n public | balances                 | table | postgres\n public | blocks                   | table | postgres\n public | blocks_internal_commands | table | postgres\n public | blocks_user_commands     | table | postgres\n public | epoch_data               | table | postgres\n public | internal_commands        | table | postgres\n public | public_keys              | table | postgres\n public | snarked_ledger_hashes    | table | postgres\n public | timing_info              | table | postgres\n public | user_commands            | table | postgres\n(10 rows)\n"})}),(0,i.jsxs)(n.admonition,{type:"note",children:[(0,i.jsx)(n.mdxAdmonitionTitle,{}),(0,i.jsxs)(n.p,{children:["A new ",(0,i.jsx)(n.code,{children:"archive_balances_migrated"})," database has been created\nThe ",(0,i.jsx)(n.code,{children:"archive"}),"database is useless"]})]})]}),"\n",(0,i.jsxs)(n.admonition,{type:"success",children:[(0,i.jsx)(n.mdxAdmonitionTitle,{children:(0,i.jsx)(n.strong,{children:"THE DUMP IS IMPORTED !!"})}),(0,i.jsx)(n.p,{children:"The dump has been successfully imported.\nWe can check the latest leist of blocks that are present in the database :"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"archive_balances_migrated=## select * from blocks order by global_slot desc limit 10;\n\n   id    |                      state_hash                      | parent_id |                     parent_hash                      | creator_id | block_winner_id | snarked_ledger_hash_id | staking_epoch_data_id | next_epoch_data_id |                     ledger_hash                     | height | global_slot | global_slot_since_genesis |   timestamp   | chain_status\n---------+------------------------------------------------------+-----------+------------------------------------------------------+------------+-----------------+------------------------+-----------------------+--------------------+-----------------------------------------------------+--------+-------------+---------------------------+---------------+--------------\n 1087577 | 3NKUGWfxWbDrfybV42unX38hnZ2yqMAyLLiQYZ2B4YcrPF9L4BWc |   1087575 | 3NKfzune2ker9cP4QhJ4vuqWzfVgJJVmX1c3Th4bRQH9bvYna3g8 |      94623 |          101819 |                  75169 |                497907 |             505105 | jxJ5Me5aQP4HF9Kcm7mmmeesNFifPHF5qB3hWz8a2QxXNa9Rd7T | 339070 |      527998 |                    527998 | 1710978840000 | pending\n 1087575 | 3NKfzune2ker9cP4QhJ4vuqWzfVgJJVmX1c3Th4bRQH9bvYna3g8 |   1087573 | 3NL5P1dkGo2pXVTX7XedPK1zsvQrNreSF8YTJ1VYVMLXkCxBgfDF |       1987 |          107904 |                  75168 |                497907 |             505105 | jy1gishsu6Uts3exnAC5kCF9mNqZtMqfHaSuKhyaxuHtFCa3wiH | 339069 |      527996 |                    527996 | 1710978480000 | pending\n 1087573 | 3NL5P1dkGo2pXVTX7XedPK1zsvQrNreSF8YTJ1VYVMLXkCxBgfDF |   1087571 | 3NLuoC89qa6cGjZ9m5idfAQjsVK5ShNdJmbUWY6KpuEotD4Df7Rp |     162470 |          162558 |                  75168 |                497907 |             505105 | jwshPjoFVzh7gxhhvwBn24DEZoE7s859q8nW5iLiqik7x9T1kVR | 339068 |      527994 |                    527994 | 1710978120000 | pending\n 1087571 | 3NLuoC89qa6cGjZ9m5idfAQjsVK5ShNdJmbUWY6KpuEotD4Df7Rp |   1087566 | 3NKTBEhAuHgr43f3bpRsrJ7PuFKtjT3sfMQBDWSxfwkgpoFyK67o |       1483 |             205 |                  75168 |                497907 |             505105 | jwNvj1eFX2V7eRL6gDHJwprcHjJNQnDggHVErY1w7Hd7Nf1iJxV | 339067 |      527993 |                    527993 | 1710977940000 | pending\n 1087569 | 3NKXFvaxf7YVhtt5FQKupVcEWWdvDmcaQVKYB5LRoXUuDxbvk9TV |   1087566 | 3NKTBEhAuHgr43f3bpRsrJ7PuFKtjT3sfMQBDWSxfwkgpoFyK67o |       1483 |             205 |                  75168 |                497907 |             505105 | jxDPWezuPbPst28NbtzXJv5EWpC1WVFaqW8quCmrzQPdnRsGbFu | 339067 |      527993 |                    527993 | 1710977940000 | pending\n 1087568 | 3NKDL6KnnRQUEruiNEHQM1eeYyTU3E6RPLiS2AQqNGRYiBqk9HUj |   1087566 | 3NKTBEhAuHgr43f3bpRsrJ7PuFKtjT3sfMQBDWSxfwkgpoFyK67o |       1483 |             205 |                  75168 |                497907 |             505105 | jxmxAWv7a7Gje8tG33xYaJvQWs3TJrVU7wyAwJYqQkHhaaTFXiu | 339067 |      527993 |                    527993 | 1710977940000 | pending\n 1087565 | 3NKCM4JqTrznCHxr7Xs1djmT4QAMNnZonawE9wghENC5QZU2SZGv |   1087563 | 3NLyYqoniFRMtmkcRkNVJX5Zy15eFNefpTxon57RsrTV63Ysmv25 |       1396 |            3507 |                  75168 |                497907 |             505105 | jxHdFJ3EYRpBhvfUWKpQyV8t2sETSkJCPcQhqe8V6XsRJH6vaHS | 339066 |      527991 |                    527991 | 1710977580000 | pending\n 1087566 | 3NKTBEhAuHgr43f3bpRsrJ7PuFKtjT3sfMQBDWSxfwkgpoFyK67o |   1087563 | 3NLyYqoniFRMtmkcRkNVJX5Zy15eFNefpTxon57RsrTV63Ysmv25 |       1396 |            3507 |                  75168 |                497907 |             505105 | jwFrq2DwysFpHqNvpTRvH67h52W6vNWztmqAC99pZrZ7A63Vdz9 | 339066 |      527991 |                    527991 | 1710977580000 | pending\n 1087563 | 3NLyYqoniFRMtmkcRkNVJX5Zy15eFNefpTxon57RsrTV63Ysmv25 |   1087558 | 3NLoCUELuKCVRgf6oWKdYtzisjgMonZQjRw81fB61geeXBkwyDYB |       1419 |           97463 |                  75168 |                497907 |             505105 | jxYLcPbCDiiBKdoSZzpuss5HhDUEbVUaxVq7BhvSvr1KtcefvU4 | 339065 |      527988 |                    527988 | 1710977040000 | pending\n 1087559 | 3NKhopfj2JKqFvi7kGe3LL1xUbz7E6CbLQpUh1xgdqCAMhPgM53a |   1087556 | 3NL4US8Vt4RCDdWegfA24nFZiJKGHBS1AYHETt9Y7wLcXScvx5ZA |       1483 |           71062 |                  75168 |                497907 |             505105 | jwrqN8xGVmxSV7Z5BvQMWeMupBoa7yX5sjuM84ZPm3sCuWHRa9a | 339064 |      527987 |                    527987 | 1710976860000 | pending\n"})})]}),"\n",(0,i.jsx)(n.h3,{id:"starting-the-mina-archive-container",children:"Starting the mina-archive container"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker run --name mina-archive -p 3086:3086 -v /tmp/archive:/data --entrypoint /bin/bash -it 154109f4622a\n"})}),"\n",(0,i.jsx)(n.h3,{id:"running-mina-archive",children:"Running mina-archive"}),"\n",(0,i.jsxs)(n.p,{children:["First check the IP adress of the docker container running postgres : ",(0,i.jsx)(n.code,{children:"172.17.0.3"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ docker exec -it postgres bash\nroot@f4f526a38062:/## ifconfig\neth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500\n        inet 172.17.0.3  netmask 255.255.0.0  broadcast 172.17.255.255\n        ether 02:42:ac:11:00:03  txqueuelen 0  (Ethernet)\n        RX packets 145546  bytes 36562420 (34.8 MiB)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 149990  bytes 319049761 (304.2 MiB)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n\nlo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536\n        inet 127.0.0.1  netmask 255.0.0.0\n        loop  txqueuelen 1000  (Local Loopback)\n        RX packets 0  bytes 0 (0.0 B)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 0  bytes 0 (0.0 B)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Then run an interactive bash shell to the ",(0,i.jsx)(n.code,{children:"mina-archive"})," container and run the ",(0,i.jsx)(n.code,{children:"mina-archive"})," process :"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ docker exec -it mina-archive bash\nroot@69c535e2f0b6:/## mina-archive run --postgres-uri postgres://postgres@172.17.0.3:5432/archive_balances_migrated --server-port 3086\n"})}),"\n",(0,i.jsxs)(n.admonition,{title:"SUCCESS",type:"success",children:[(0,i.jsxs)(n.p,{children:["You are all done !!\nYou can get the last block indexed from the database by entering an interactive bash session to the ",(0,i.jsx)(n.code,{children:"postgres"}),"container :"]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ docker exec -it postgres bash\nroot@f4f526a38062:/## psql -U postgres -d archive_balances_migrated\npsql (16.2 (Debian 16.2-1.pgdg120+2))\nType \"help\" for help.\n\narchive_balances_migrated=## SELECT TO_CHAR(TO_TIMESTAMP(timestamp / 1000), 'YYYY-MM-DD HH24:MI:SS') AS utc_time, height, global_slot from blocks order by timestamp desc limit 1;\n      utc_time       | height | global_slot\n---------------------+--------+-------------\n 2024-03-21 14:24:00 | 339249 |      528288\n(1 row)\n\n"})})]}),"\n",(0,i.jsx)(n.h2,{id:"catchup-missing-blocks",children:"Catchup missing blocks"}),"\n",(0,i.jsxs)(n.p,{children:["In order to catchup missing block, we will use a shell script available here : ",(0,i.jsx)(n.a,{href:"https://github.com/MinaProtocol/mina/blob/develop/scripts/archive/download-missing-blocks.sh",children:"https://github.com/MinaProtocol/mina/blob/develop/scripts/archive/download-missing-blocks.sh"})]}),"\n",(0,i.jsxs)(n.admonition,{title:"Script execution",type:"warning",children:[(0,i.jsx)(n.p,{children:"The script execution requires some tools from the mina-archive package.\nNotably :"}),(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"mina-missing-blocks-auditor"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"mina-archive-blocks"})}),"\n"]})]}),"\n",(0,i.jsx)(n.p,{children:"It means that the script can only be executed from the mina-archive docker container.\nSo we copy the script to the mina-archive container :"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker cp download-missing-blocks.sh mina-archive:/\n"})}),"\n",(0,i.jsxs)(n.admonition,{type:"warning",children:[(0,i.jsx)(n.mdxAdmonitionTitle,{children:(0,i.jsx)(n.strong,{children:"PROBLEM"})}),(0,i.jsx)(n.p,{children:"Now the big problem when running the script from the mina-archive docker container is that it tries to connect to the archive database but failed to do so due to docker network isolation :-("}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"psql -h localhost -p 5432 -U postgres -d archive_balances_migrated\n"})}),(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"FAILS"})})]}),"\n",(0,i.jsxs)(n.admonition,{title:"SOLUTION",type:"success",children:[(0,i.jsx)(n.p,{children:"Use Docker Postgresql network ip address"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"root@69c535e2f0b6:/## export PGPASSWORD=postgres\nroot@69c535e2f0b6:/## ./download-missing-blocks.sh -n mainnet -a postgres://postgres@172.17.0.3:5432/archive_balances_migrated\n"})})]}),"\n",(0,i.jsx)(n.h2,{id:"useful-commands",children:"USEFUL COMMANDS"}),"\n",(0,i.jsx)(n.h3,{id:"list-running-docker-containers",children:"List running docker containers"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker ps\n"})}),"\n",(0,i.jsx)(n.h3,{id:"docker-container-logs",children:"Docker container logs"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker logs mina\n"})}),"\n",(0,i.jsx)(n.h3,{id:"launch-interactive-shell-session",children:"Launch interactive shell session"}),"\n",(0,i.jsx)(n.h5,{id:"postgres-container",children:"POSTGRES Container"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker exec -it postgres bash\n"})}),"\n",(0,i.jsx)(n.h5,{id:"mina-container",children:"Mina Container"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker exec -it mina bash\n"})}),"\n",(0,i.jsx)(n.h5,{id:"mina-archive-container",children:"Mina Archive Container"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker exec -it mina-archive bash\n"})}),"\n",(0,i.jsx)(n.h5,{id:"copy-a-local-file-to-a-container",children:"Copy a local file to a container"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker cp mainnet-archive-dump-2024-03-28_0001.sql postgres:/mainnet-archive-dump-2024-03-28_0001.sql\ndocker cp download-missing-blocks.sh mina-archive:/\n"})}),"\n",(0,i.jsx)(n.h5,{id:"running-mina-archive-container",children:"Running Mina Archive Container"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker run --name mina-archive -p 3086:3086 -v /tmp/archive:/data --entrypoint /bin/bash -it 154109f4622a\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsx)(n.p,{children:"We forward port 3086 in order for the mina daemon to be able to connect to the mina-archive process.\nWe also map /tmp/archive to /data\nThe archive process will be launched manually from within the container (not ideal but more control over)"})}),"\n",(0,i.jsxs)(n.h5,{id:"running-the-postgres-container",children:["Running the ",(0,i.jsx)(n.code,{children:"postgres"})," container"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker run --name postgres -p 5432:5432 -e POSTGRES_PASSWORD=postgres -d postgres\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},11151:(e,n,a)=>{a.d(n,{Z:()=>c,a:()=>t});var i=a(67294);const r={},s=i.createContext(r);function t(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);